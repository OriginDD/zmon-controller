<div class="row">
    <div class="col-md-6">
        <h1>Alert: {{alertDefinition.name}} <priority prio="alertDefinition.priority" /></h1>
    </div>
    <div class="col-md-6 text-right">
        <p>
            ID: {{alertDefinition.id}},
            Status: <status status="alertDefinition.status"/>,
            Team: {{alertDefinition.team}}
        </p>
        <p>
            <a ng-show="alertDefinition.editable && alertDefinition.status != 'DELETED'" href="#/alert-definitions/edit/{{alertDefinition.id}}" title="Edit alert definition"><i class="fa fa-fw fa-edit"></i> Edit</a>
            <span ng-hide="alertDefinition.editable ||  alertDefinition.status == 'DELETED'"><i class="fa fa-fw fa-edit semi-transparent"></i> Edit</span>
            <a ng-show="alertDefinition.cloneable && alertDefinition.status != 'DELETED'" href="#/alert-definitions/clone/{{alertDefinition.id}}" title="Clone alert definition"><i class="fa fa-fw fa-copy"></i> Clone</a>
            <span ng-hide="alertDefinition.cloneable || alertDefinition.status == 'DELETED'"><i class="fa fa-fw fa-copy semi-transparent"></i> Clone</span>
            <a ng-show="alertDefinition.cloneable && alertDefinition.status != 'DELETED'" href="#/alert-definitions/inherit/{{alertDefinition.id}}" title="Inherit alert definition"><i class="fa fa-fw fa-sitemap"></i> Inherit</a>
            <span ng-hide="alertDefinition.cloneable || alertDefinition.status == 'DELETED'"><i class="fa fa-fw fa-sitemap semi-transparent"></i> Inherit</span>
            <a ng-show="alertDefinition.deletable" href=""ng-click="showDeleteAlertDefinitionModal()" title="Delete alert definition"><i class="fa fa-fw fa-trash-o"></i> Delete</a>
            <span ng-hide="alertDefinition.deletable"><i class="fa fa-fw fa-trash-o semi-transparent"></i> Delete</span>
            <a href="#/history?alert_definition_id={{alertDefinition.id}}"><i class="fa fa-clock-o"></i> History</a>
            <a class="clickable" href="/#/trial-run?json={{alertJson}}"><i class="fa fa-play"></i> Trial Run</a>
            <a class="clickable" ng-if="userInfo['instantaneous-alert-evaluation']" ng-click="forceAlertEvaluation()"><i class="fa fa-play"></i> Evaluate</a>
            <a class="clickable" ng-if="userInfo['instantaneous-alert-evaluation']" ng-click="forceAlertCleanup()"><i class="fa fa-eraser"></i> Cleanup</a>
            <comment-dialog class="fake-link comment-dialog-trigger" indicator="true" uid="alertDefinition.id" label="Comments" update="true" data="alertComments" save="saveComment(comment, cb)" delete="deleteComment(id, cb)" load="getComments(id, limit, offset, cb)" show-count="true"></comment-dialog>
        </p>
    </div>
</div>

<div class="panel panel-default">
    <div class="panel-body">
        <dl class="dl-horizontal">
            <dt>Description</dt>
            <dd class="form-control" ng-bind-html="alertDefinition.description | markdown"></dd>
            <dt>Condition</dt>
            <dd><pre class="z-code">{{alertDefinition.condition}}</pre></dd>
            <dt>Responsible Team</dt>
            <dd>{{alertDefinition.responsible_team}}</dd>
        </dl>
    </div>
</div>

<div class="panel panel-default details" ng-class="{'panel-collapsed': !showDetails}">
    <div class="panel-heading panel-toggle" ng-click="showDetails = !showDetails"><i class="fa fa-fw fa-toggle-{{ showDetails ? 'up' : 'down' }}"></i> Details</div>
    <div class="panel-body">
        <dl class="dl-horizontal">
            <dt ng-if="checkDefinition.potential_impact" >Potential Impact</dt>
            <dd ng-if="checkDefinition.potential_impact" ng-bind-html="checkDefinition.potential_impact | markdown"></dd>
            <dt ng-if="checkDefinition.potential_analysis">Potential Analysis</dt>
            <dd ng-if="checkDefinition.potential_analysis" ng-bind-html="checkDefinition.potential_analysis | markdown"></dd>
            <dt ng-if="checkDefinition.potential_solution">Potential Solution</dt>
            <dd ng-if="checkDefinition.potential_solution" ng-bind-html="checkDefinition.potential_solution | markdown"></dd>
            <dt ng-if="checkDefinition.technical_details">Technical Details</dt>
            <dd ng-if="checkDefinition.technical_details" ng-bind-html="checkDefinition.technical_details | markdown"></dd>
            <dt ng-if="alertDefinition.parent_id">Inherits from</dt>
            <dd ng-if="alertDefinition.parent_id"><a href="/#/alert-details/{{alertDefinition.parent_id}}">{{parentAlertDefinition.name || "(no name)"}}</a>, ID: <a href="/#/alert-details/{{alertDefinition.parent_id}}">{{alertDefinition.parent_id}}</a></dd>
            <dt>Check Name, ID, History</dt>
            <dd><a href="#/check-definitions/view/{{checkDefinition.id}}">{{checkDefinition.name}}</a>, ID: {{checkDefinition.id}}, <a href="#/history?check_definition_id={{checkDefinition.id}}">History</a></dd>
            <dt>Check Team</dt>
            <dd>{{checkDefinition.owning_team}}</dd>
            <dt>Check Command</dt>
            <dd><pre class="z-code">{{checkDefinition.command}}</pre></dd>
            <dt>Check Interval</dt>
            <dd>{{checkDefinition.interval|timespan:'s'}}</dd>
            <dt>Check Entities</dt>
            <dd ng-bind-html="checkDefinition.entities | entities"></dd>
            <dt>Parameters</dt>
            <dd class="text-muted" ng-if="alertDefinition.parameters == null">(no parameters)</dd>
            <dd ng-repeat="(name, parameter) in alertDefinition.parameters">
                {{name}} = {{parameter.value}}
            </dd>
            <dt>Entities Filter</dt>
            <dd><span class="text-muted" ng-show="alertDefinition.entities.length === 0">(no entities)</span>
            <div ng-bind-html="alertDefinition.entities | entities"></div></dd>
            <dt>Excluded Entities Filter</dt>
            <dd><span class="text-muted" ng-show="alertDefinition.entities_exclude === undefined || alertDefinition.entities_exclude.length === 0">(no excluded entities)</span>
            <div ng-bind-html="alertDefinition.entities_exclude | entities"></div></dd>
            <dt>Notifications</dt>
            <dd><span class="text-muted" ng-show="alertDefinition.notifications.length === 0">(no notifications defined)</span><code ng-repeat="notification in alertDefinition.notifications">{{notification}}</code></dd>
            <dt>Time Period</dt>
            <dd><span class="text-muted" ng-show="!alertDefinition.period">(no time periods defined)</span>{{alertDefinition.period}}</dd>
            <dt><label class="select2-details">Tags</label></dt>
            <dd><input type="hidden" class="form-control disabled" zmon-select multi="true" tags="true" visible="true" width="100%" disabled="disabled" default="alertDefinition.tags"/></dd>
        </dl>
    </div>
</div>
    <div ng-if="alertDefinition.status == 'ACTIVE'">
        <tabset>
            <tab id="alerts-tab" heading="Alerts/Checks">
                <div class="zmon-controls row">
                    <div class="col-md-8">
                        <button class="btn" ng-class="{'active-page': showActiveAlerts && activeAlerts.length > 0}" ng-disabled="activeAlerts.length === 0" ng-click="toggleShowEntities('activeAlerts')">Alerts ({{activeAlerts.length}})</button>
                        <button class="btn" ng-class="{'active-page': showAlertsInDowntime && alertsInDowntime.length > 0}" ng-disabled="alertsInDowntime.length === 0" ng-click="toggleShowEntities('alertsInDowntime')">In downtime ({{alertsInDowntime.length}})</button>
                        <button class="btn" ng-class="{'active-page': showCheckResults && checkResults.length > 0}" ng-disabled="checkResults.length === 0" ng-click="toggleShowEntities('checkResults')">OK ({{checkResults.length}})</button>
                        <span ng-show="addDowntimeEntities != 0">Selected: {{addDowntimeEntities.length}}</span>
                    </div>
                    <div class="col-md-4 text-right">
                        <form id="searchbar" class="form-inline">
                            <div class="form-group">
                                <div class="input-group">
                                    <span class="input-group-btn">
                                        <button class="btn btn-primary"><i class="fa fa-fw fa-search"></i></button>
                                    </span>
                                    <input class="form-control alert-details-search" placeholder="Filter entities"  type="text" ng-model="alertDetailsSearch" autofocus />
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="zmon-data-table table table-striped table-bordered table-hover table-condensed">
                        <thead>
                            <tr>
                                <th class="actions-col">
                                    <div ng-if="userInfo['schedule-downtime']">
                                        <button id="set-downtimes-button" ng-disabled="addDowntimeEntities.length == 0" ng-click="showDowntimeModal(alertDetails.alert_definition.id)" class="fa fa-flag btn btn-primary" title="Schedule downtime"> </button>
                                    <input id="select-all-schedule-downtimes" type="checkbox" ng-checked="areAllDisplayedAlertsChecked()" ng-show="getTotalNumDisplayedAlerts()" ng-click="toggleAllEntitiesAddDowntime()">
                                    </div>
                                </th>
                                <th class="name-col" ng-click="sortType = 'entity'; sortOrder = !sortOrder">Name
                                    <i class="fa fa-fw fa-sort-asc sort-arrow" ng-show="sortType === 'entity' && sortOrder"></i>
                                    <i class="fa fa-fw fa-sort-desc sort-arrow" ng-show="sortType === 'entity' && !sortOrder"></i>
                                </th>
                                <th class="last-run-col" ng-click="sortType = 'result.ts'; sortOrder = !sortOrder">Last run
                                    <i class="fa fa-fw fa-sort-asc sort-arrow" ng-show="sortType === 'result.ts' && sortOrder"></i>
                                    <i class="fa fa-fw fa-sort-desc sort-arrow" ng-show="sortType === 'result.ts' && !sortOrder"></i>
                                </th>
                                <th class="active-since-col" ng-click="sortType = 'result.start_time'; sortOrder = !sortOrder">Active since
                                    <i class="fa fa-fw fa-sort-asc sort-arrow" ng-show="sortType === 'result.start_time' && sortOrder"></i>
                                    <i class="fa fa-fw fa-sort-desc sort-arrow" ng-show="sortType === 'result.start_time' && !sortOrder"></i>
                                </th>
                                <th class="value-col" ng-click="sortType = 'result.value'; sortOrder = !sortOrder">Value
                                    <i class="fa fa-fw fa-sort-asc sort-arrow" ng-show="sortType === 'result.value' && sortOrder"></i>
                                    <i class="fa fa-fw fa-sort-desc sort-arrow" ng-show="sortType === 'result.value' && !sortOrder"></i>
                                </th>
                                <th class="captures-col" ng-click="sortType = 'result.captures'; sortOrder = !sortOrder">Captures
                                    <i class="fa fa-fw fa-sort-asc sort-arrow" ng-show="sortType === 'result.captures' && sortOrder"></i>
                                    <i class="fa fa-fw fa-sort-desc sort-arrow" ng-show="sortType === 'result.captures' && !sortOrder"></i>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr ng-repeat="entityInstance in allAlertsAndChecks | filter:alertDetailsSearch | inDisplayedGroup:showActiveAlerts:showAlertsInDowntime:showCheckResults | orderBy:sortType:sortOrder track by entityInstance.entity" ng-class="{'danger': entityInstance.isActiveAlert == true, 'active-downtime': entityInstance.isAlertInDowntime == true, 'success': entityInstance.isCheckResult == true}">
                                <td class="text-center">
                                    <a href="/grafana/dashboard/db/zmon-check-{{checkDefinition.id}}-{{ entityInstance.entity }}"><i class="fa fa-fw fa-bar-chart-o"></i></a>
                                    <comment-dialog class="fake-link" uid="alertDefinition.id" entity="entityInstance.entity"  save="saveComment(comment, cb)" delete="deleteComment(id, cb)" load="getComments(id, limit, offset, cb)" show-count="false"></comment-dialog>
                                    <input ng-if="userInfo['schedule-downtime']" class="set-downtime-checkbox" type="checkbox" ng-checked="addDowntimeEntities.indexOf(entityInstance.entity) > -1" ng-click="toggleEntityAddDowntime(entityInstance.entity)">
                                </td>
                                <td><a href="/#/entities?ef=id:{{entityInstance.entity}}" title="{{entityInstance.entity}}">{{entityInstance.entity | entityName}}</a></td>
                                <td><div title="{{entityInstance.result.td * 1000|timespan}} {{entityInstance.result.worker}}">
                                        <span ng-class="{'alert-is-too-old': timestampIsOld(entityInstance)}">{{entityInstance.result.ts|datetime}} ({{timeAgo(entityInstance.result.ts)}} ago)</span></div></td>
                                <td>
                                    <div ng-if="entityInstance.result.start_time">
                                        {{entityInstance.result.start_time | datetime}}
                                        ({{timeAgo(entityInstance.result.start_time)}} ago)
                                    </div>
                                </td>
                                <td>
                                    <div class="ellipsis" expand>{{entityInstance.result.value}}
                                        <div ng-if="entityInstance.isAlertInDowntime == true">
                                            {{entityInstance.result.downtimes | downtimeReasons}}
                                        </div>
                                    </div>

                                </td>
                                <td>
                                    <div class="ellipsis" expand>{{entityInstance.result.captures}}</div></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </tab>
            <tab id="downtimes-tab" heading="Downtimes ({{allDowntimes.length}})" disabled="allDowntimes.length == 0">
                <table class="zmon-data-table table table-striped table-bordered table-hover table-condensed">
                    <thead>
                        <tr>
                            <th class="text-center actions-col" ng-if="userInfo['delete-downtime']">
                                <button id="delete-downtimes-button" ng-disabled="deleteDowntimeUUIDs.length == 0" ng-click="deleteMultiDowntimes()" class="fa fa-trash-o btn btn-primary"> </button>
                                <input id="select-all-delete-downtimes" type="checkbox" ng-checked="areAllDowntimesChecked()" ng-click="toggleAllDeleteDowntimes()">
                            </th>
                            <th class="name-col" ng-click="sortType = 'entity'; sortOrder = !sortOrder">Entity
                                    <i class="fa fa-fw fa-sort-asc sort-arrow" ng-show="sortType === 'entity' && sortOrder"></i>
                                    <i class="fa fa-fw fa-sort-desc sort-arrow" ng-show="sortType === 'entity' && !sortOrder"></i>
                            </th>
                            <th class="timestamp-col" ng-click="sortType = 'start_time'; sortOrder = !sortOrder">Start time
                                    <i class="fa fa-fw fa-sort-asc sort-arrow" ng-show="sortType === 'start_time' && sortOrder"></i>
                                    <i class="fa fa-fw fa-sort-desc sort-arrow" ng-show="sortType === 'start_time' && !sortOrder"></i>
                            </th>
                            <th class="timestamp-col" ng-click="sortType = 'end_time'; sortOrder = !sortOrder">End time
                                    <i class="fa fa-fw fa-sort-asc sort-arrow" ng-show="sortType === 'end_time' && sortOrder"></i>
                                    <i class="fa fa-fw fa-sort-desc sort-arrow" ng-show="sortType === 'end_time' && !sortOrder"></i>
                            </th>
                            <th ng-click="sortType = 'comment'; sortOrder = !sortOrder">Comment
                                    <i class="fa fa-fw fa-sort-asc sort-arrow" ng-show="sortType === 'comment' && sortOrder"></i>
                                    <i class="fa fa-fw fa-sort-desc sort-arrow" ng-show="sortType === 'comment' && !sortOrder"></i>
                            </th>
                            <th class="modified-by-col" ng-click="sortType = 'created_by'; sortOrder = !sortOrder">Created by
                                    <i class="fa fa-fw fa-sort-asc sort-arrow" ng-show="sortType === 'created_by' && sortOrder"></i>
                                    <i class="fa fa-fw fa-sort-desc sort-arrow" ng-show="sortType === 'created_by' && !sortOrder"></i>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- And then show the entities downtimes -->
                        <tr class="warning" ng-repeat="downtimeInstance in allDowntimes| filter:alertDetailsSearch | orderBy:sortTypeDowntimes:sortOrderDowntimes">
                            <td ng-if="userInfo['delete-downtime']" class="text-center"><input type="checkbox" ng-checked="deleteDowntimeUUIDs.indexOf(downtimeInstance.id) > -1" ng-click="toggleSingleDeleteDowntime(downtimeInstance.id)"></td>
                            <td>{{downtimeInstance.entity}}</td>
                            <td>{{downtimeInstance.start_time | epochToDate}}</td>
                            <td>{{downtimeInstance.end_time | epochToDate}}</td>
                            <td class="ellipsis" expand>{{downtimeInstance.comment}}</td>
                            <td>{{downtimeInstance.created_by}}</td>
                        </tr>
                    </tbody>
                </table>
            </tab>
            <tab heading="History" select="fetchHistoryLastNDays(1)">
                <div class="zmon-controls">
                    Events from <em>{{historyFromInEpochSeconds * 1000 | date:'medium'}}</em> till now
                    <button class="btn" ng-class="{'active-page': activeHistoryButton['1']}" ng-click="fetchHistoryLastNDays(1)">Last day</button>
                    <button class="btn" ng-class="{'active-page': activeHistoryButton['7']}" ng-click="fetchHistoryLastNDays(7)">Last 7 days</button>
                    <button class="btn" ng-class="{'active-page': activeHistoryButton['14']}" ng-click="fetchHistoryLastNDays(14)">Last 14 days</button>
                    <button class="btn" ng-class="{'active-page': activeHistoryButton['-1']}" ng-click="fetchOneMoreWeekOfHistory()">+1 week</button>
                </div>
                <table class="table table-striped table-bordered table-hover table-condensed">
                    <thead>
                        <tr>
                            <th class="col-sm-2">When</th>
                            <th class="col-sm-2">Type</th>
                            <th>User</th>
                            <th>Entity</th>
                            <th>Content</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr ng-repeat="entry in allHistory" ng-if="entry.type_name != 'TRIAL_RUN_SCHEDULED'">
                            <td>{{entry.time | epochToDate}}</td>
                            <td class="text-center">
                            <span class="history-tag" style="background-color: hsla({{HSLaFromHistoryEventTypeId(entry.type_id)}}, 50%, 50%, 1);">{{entry.type_name}}</span>
                            </td>
                            <td>{{entry.attributes.userName}}</td>
                            <td>{{entry.attributes.entity}}</td>
                            <td>{{getHistoryContent(entry.type_name, entry.attributes)}} </td>
                        </tr>
                    </tbody>
                </table>
            </tab>
            <tab id="children-tab" heading="Children ({{alertDefinitionChildren.length}})" disabled="alertDefinitionChildren.length == 0">
                <table class="zmon-data-table table table-striped table-bordered table-hover table-condensed">
                    <thead>
                        <tr>
                            <th class="name-col" ng-click="sortType = 'name'; sortOrder = !sortOrder">Name
                                    <i class="fa fa-fw fa-sort-asc sort-arrow" ng-show="sortType === 'name' && sortOrder"></i>
                                    <i class="fa fa-fw fa-sort-desc sort-arrow" ng-show="sortType === 'name' && !sortOrder"></i>
                            </th>
                            <th ng-click="sortType = 'condition'; sortOrder = !sortOrder">Condition
                                    <i class="fa fa-fw fa-sort-asc sort-arrow" ng-show="sortType === 'condition' && sortOrder"></i>
                                    <i class="fa fa-fw fa-sort-desc sort-arrow" ng-show="sortType === 'condition' && !sortOrder"></i>
                            </th>
                            <th>Parameters</th>
                            <th class="entities-col" ng-click="sortType = 'entities'; sortOrder = !sortOrder">Entities
                                    <i class="fa fa-fw fa-sort-asc sort-arrow" ng-show="sortType === 'entities' && sortOrder"></i>
                                    <i class="fa fa-fw fa-sort-desc sort-arrow" ng-show="sortType === 'entities' && !sortOrder"></i>
                            </th>
                            <th class="check-id-col" ng-click="sortType = 'check_definition_id'; sortOrder = !sortOrder">Check ID
                                    <i class="fa fa-fw fa-sort-asc sort-arrow" ng-show="sortType === 'check_definition_id' && sortOrder"></i>
                                    <i class="fa fa-fw fa-sort-desc sort-arrow" ng-show="sortType === 'check_definition_id' && !sortOrder"></i>
                            </th>
                            <th class="team-col" ng-click="sortType = 'team'; sortOrder = !sortOrder">Team
                                    <i class="fa fa-fw fa-sort-asc sort-arrow" ng-show="sortType === 'team' && sortOrder"></i>
                                    <i class="fa fa-fw fa-sort-desc sort-arrow" ng-show="sortType === 'team' && !sortOrder"></i>
                            </th>
                            <th class="responsible-team-col" ng-click="sortType = 'responsible_team'; sortOrder = !sortOrder">Responsible Team
                                    <i class="fa fa-fw fa-sort-asc sort-arrow" ng-show="sortType === 'responsible_team' && sortOrder"></i>
                                    <i class="fa fa-fw fa-sort-desc sort-arrow" ng-show="sortType === 'responsible_team' && !sortOrder"></i>
                            </th>
                            <th class="priority-col" ng-click="sortType = 'priority'; sortOrder = !sortOrder">Priority
                                    <i class="fa fa-fw fa-sort-asc sort-arrow" ng-show="sortType === 'priority' && sortOrder"></i>
                                    <i class="fa fa-fw fa-sort-desc sort-arrow" ng-show="sortType === 'priority' && !sortOrder"></i>
                            </th>
                            <th class="status-col" ng-click="sortType = 'status'; sortOrder = !sortOrder">Status
                                    <i class="fa fa-fw fa-sort-asc sort-arrow" ng-show="sortType === 'status' && sortOrder"></i>
                                    <i class="fa fa-fw fa-sort-desc sort-arrow" ng-show="sortType === 'status' && !sortOrder"></i>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr ng-repeat="def in alertDefinitionChildren | orderBy:sortTypeChildren:sortOrderChildren" repeat-monitor last="$last">
                            <td><a tooltip-html-unsafe="{{def.description | markdown}}" tooltip-placement="right" href="#/alert-details/{{def.id}}">{{def.name || '(no name)'}}</a></td>
                            <td class="ellipsis" expand>{{def.condition}}</td>
                            <td><dd ng-repeat="(name, parameter) in def.parameters">{{name}} = {{parameter.value}}</dd></td>
                            <td><span class="text-muted" ng-show="def.entities.length === 0">(no entity filter)</span><div ng-bind-html="def.entities | entities"></div></td>
                            <td><a href="#/check-definitions/view/{{def.check_definition_id}}">{{def.check_definition_id}}</a></td>
                            <td>{{def.team}}</td>
                            <td>{{def.responsible_team}}</td>
                            <td class="text-center"><priority prio="def.priority"></priority></td>
                            <td><status status="def.status"></status><i id="star" class='fa fa-star' ng-show="def.star" title="new alert"></i></td>
                        </tr>
                    </tbody>
                </table>
            </tab>
        </tabset>
    </div>

    <div ng-if="alertDefinition.status === 'INACTIVE'" class="alert alert-info">
        This alert definition has status {{ alertDefinition.status }}. Change the status to ACTIVE to enable alerting and see alert entities.
    </div>

    <div ng-if="alertDefinition.status === 'DELETED'" class="alert alert-info">
        This alert definition has status {{ alertDefinition.status }}. To finalize alert deletion please <a ng-show="alertDefinition.deletable" href=""ng-click="showDeleteAlertDefinitionModal()" title="Delete alert definition"><em>click here</em> <i class="fa fa-fw fa-trash-o"></i></a> and confirm your choice.
    </div>
